<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upstream (Typing) Chart - ì—­ë¥˜ì„± íƒ€ì ì°¨íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nanum Gothic', 'Inter', sans-serif;
            overflow: hidden;
            background-color: #f0e6d8;
        }
        .game-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            margin: 0 auto;
            background-image: url('https://www.transparenttextures.com/patterns/rice-paper-2.png');
            border: 5px solid #8B4513;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative; 
        }
        .word {
            position: absolute;
            padding: 8px 12px;
            background-color: #fff8e1;
            border: 1px solid #d4c0a1;
            border-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            font-size: 1.1rem;
            white-space: nowrap;
            color: #5d4037;
        }

        .word.matched, .word.fade-out-effect { 
            animation: fadeOutEffect 0.5s forwards;
        }
        .word.split-effect {
            animation: splitEffect 0.6s forwards;
        }
        .word.explode-effect {
            animation: explodeEffect 0.5s forwards;
        }

        @keyframes fadeOutEffect {
            0% { opacity: 1; transform: scale(1.1) translateY(0); }
            100% { opacity: 0; transform: scale(1.2) translateY(-20px); }
        }
        @keyframes splitEffect {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; }
            100% { opacity: 0; transform: translateX(30px) rotate(15deg) scale(0.5); }
        }
        @keyframes explodeEffect {
            0% { transform: scale(1.1); opacity: 1; }
            50% { transform: scale(1.3) rotate(10deg); opacity: 0.7; }
            100% { transform: scale(0.1) rotate(720deg); opacity: 0; }
        }

        .hearts-container span {
            font-size: 1.5rem;
            color: #e53e3e;
            margin-right: 4px;
        }
        .message-box {
            min-height: 80px; 
            background-color: rgba(255, 255, 255, 0.85); 
            border-radius: 8px;
            padding: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5; 
            position: relative; 
        }
        .heojun-img {
            width: 60px; 
            height: auto;
            border-radius: 50%;
            border: 2px solid #8B4513;
            margin-bottom: 5px; 
        }
        button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(1px); 
        }
        .start-button { background-color: #4CAF50; }
        .start-button:hover { background-color: #45a049; }
        .restart-button { background-color: #f44336; }
        .restart-button:hover { background-color: #e53935; }
        #ingameRestartButton {
            position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; padding: 0.5rem; 
            z-index: 20; background-color: rgba(239, 221, 193, 0.8); 
            color: #8B4513; border: 1px solid #d4c0a1; line-height: 1; 
        }
        #ingameRestartButton:hover { background-color: rgba(239, 221, 193, 1); }
        .quiz-button { background-color: #2196F3; margin: 0 5px; padding: 8px 15px; }
        .quiz-button:hover { background-color: #1e88e5; }
        #quizLoading { font-style: italic; color: #777; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #8B4513; 
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; margin: 5px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
        @media (max-width: 640px) {
            .word { font-size: 1rem; padding: 6px 10px; }
            .stats-bar > div { font-size: 0.9rem; }
            .hearts-container span { font-size: 1.3rem; }
            .message-box { font-size: 0.9rem; min-height: 70px; }
            #wordInput { font-size: 1rem; padding: 8px; }
            .game-title { font-size: 1.5rem; }
            .quiz-button { padding: 6px 10px; font-size: 0.9rem;}
            #ingameRestartButton { font-size: 1.25rem; top: 0.5rem; right: 0.5rem; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-yellow-50 flex items-center justify-center min-h-screen">

    <div id="gameContainer" class="game-container flex flex-col p-4 relative overflow-hidden hidden">
        <button id="ingameRestartButton" class="rounded-full shadow-md" title="ê²Œì„ ë‹¤ì‹œ ì‹œì‘">ğŸ”„</button>
        <h1 class="game-title text-3xl font-bold text-center text-amber-700 my-4">Upstream (Typing) Chart</h1>
        <div class="stats-bar flex justify-between items-center mb-4 p-2 bg-amber-100 rounded-lg shadow">
            <div class="text-lg">ì ìˆ˜: <span id="score" class="font-bold">0</span></div>
            <div id="heartsContainer" class="hearts-container"></div>
        </div>
        <div id="wordArea" class="flex-grow w-full relative border-2 border-dashed border-amber-400 rounded-md bg-white bg-opacity-50"></div>
        <input type="text" id="wordInput" class="w-full p-3 mt-4 border-2 border-amber-600 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <div id="messageArea" class="message-box mt-4 text-center text-amber-800 text-sm">
            <span id="mainMessageText">í•œì•½ ì´ë¦„ì´ ë–¨ì–´ì§€ê¸° ì „ì— ì…ë ¥í•˜ì„¸ìš”!</span>
             <div id="quizLoading" class="hidden"><div class="loader"></div>í€´ì¦ˆ ìƒì„± ì¤‘...</div>
            <div id="quizSection" class="hidden mt-2 w-full"> 
                <p id="quizText" class="font-semibold mb-1"></p>
                <div id="quizOptions" class="flex justify-center"> 
                    <button id="quizBtnO" class="quiz-button">O (ë§ë‹¤)</button>
                    <button id="quizBtnX" class="quiz-button">X (ì•„ë‹ˆë‹¤)</button>
                </div>
            </div>
        </div>
    </div>
    <div id="startScreen" class="absolute inset-0 bg-amber-50 bg-opacity-90 flex flex-col items-center justify-center z-10">
        <h2 class="text-4xl font-bold text-amber-700 mb-6">ì—­ë¥˜ì„± íƒ€ì ì°¨íŠ¸</h2>
        <img src="https://placehold.co/150x150/A52A2A/FFFFFF?text=í—ˆì¤€&font=NanumGothic" alt="í—ˆì¤€ ì•„ì´ì½˜" class="heojun-img mb-6 shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/150x150/A52A2A/FFFFFF?text=í—ˆì¤€&font=NanumGothic';">
        <p class="text-amber-700 mb-2 text-center px-4">í•˜ëŠ˜ì—ì„œ ë–¨ì–´ì§€ëŠ” í•œì•½ ì´ë¦„ì„ ë¹ ë¥´ê²Œ ì…ë ¥í•˜ì—¬<br>í™˜ì(?)ì˜ ë§ˆìŒì„ ì•ˆì •ì‹œí‚¤ì„¸ìš”!</p>
        <p class="text-sm text-amber-600 mb-8">(ê°€ë” ì–´ì˜ í—ˆì¤€ ì„ ìƒë‹˜ì´ âœ¨íŠ¹ë³„í•œ ë„ì›€âœ¨ì„ ì£¼ì‹­ë‹ˆë‹¤)</p>
        <button id="startButton" class="start-button px-8 py-3 text-xl">ê²Œì„ ì‹œì‘</button>
    </div>
    <div id="gameOverScreen" class="absolute inset-0 bg-red-50 bg-opacity-95 flex-col items-center justify-center z-10 hidden">
        <h2 class="text-4xl font-bold text-red-700 mb-4">ê²Œì„ ì¢…ë£Œ!</h2>
        <p class="text-red-600 text-xl mb-2">ìµœì¢… ì ìˆ˜: <span id="finalScore" class="font-bold">0</span>ì </p>
        <p id="gameOverMessage" class="text-red-500 mb-6 text-center"></p>
        <button id="restartButton" class="restart-button px-8 py-3 text-xl">ë‹¤ì‹œ ì‹œì‘</button>
    </div>

    <script>
        // DOM Elements
        const gameContainer = document.getElementById('gameContainer');
        const wordArea = document.getElementById('wordArea');
        const scoreDisplay = document.getElementById('score');
        const heartsContainer = document.getElementById('heartsContainer');
        const wordInput = document.getElementById('wordInput');
        const messageArea = document.getElementById('messageArea');
        const mainMessageTextEl = document.getElementById('mainMessageText');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton'); 
        const ingameRestartButton = document.getElementById('ingameRestartButton'); 
        const finalScoreDisplay = document.getElementById('finalScore');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const quizSection = document.getElementById('quizSection');
        const quizText = document.getElementById('quizText');
        const quizOptions = document.getElementById('quizOptions');
        const quizLoading = document.getElementById('quizLoading');
        const quizBtnO = document.getElementById('quizBtnO');
        const quizBtnX = document.getElementById('quizBtnX');

        const herbWords = [
            "ê°ì´ˆ", "ì¸ì‚¼", "ë‹¹ê·€", "í™©ê¸°", "ë°±ì¶œ", "ë³µë ¹", "ìˆ™ì§€í™©", "ì²œê¶", "ì‘ì•½", "ê³„í”¼", "ë§¥ë¬¸ë™", "ì˜¤ë¯¸ì", "êµ¬ê¸°ì", "ì‚°ìˆ˜ìœ ",
            "ë‘ì¶©", "ê°ˆê·¼", "ë°©í’", "ê°•í™œ", "ë…í™œ", "ì‹œí˜¸", "ìŠ¹ë§ˆ", "ì§„í”¼", "ë°˜í•˜", "ê¸¸ê²½", "í–‰ì¸", "ì˜ì´ì¸", "ëª©ë‹¨í”¼", "í˜„í˜¸ìƒ‰",
            "ìµëª¨ì´ˆ", "í™í™”", "í™©ê¸ˆ", "í™©ë ¨", "ëŒ€í™©", "ì§€ëª¨", "ì„ê³ ", "ì£½ì—½", "í•˜ê³ ì´ˆ", "ìš°ìŠ¬", "ì†ë‹¨", "ìœ„ë ¹ì„ ", "í•´ë™í”¼", "ëª¨ê³¼",
            "ì²œë§ˆ", "ì¡°êµ¬ë“±", "ë°±ê°•ì ", "ì „ê°ˆ", "ë…¹ìš©", "ì›…ë‹´", "ì‚¬í–¥",
            "ê¹€ì¢…ì—°", "ì •í¬ë²”", "ë©”ë””ìŠ¤íŠ¸ë¦¼", "ê³µì§„ë‹¨", "ê²½ì˜¥ê³ ", "ìˆ˜", "ë©”ë””ë¸”ë™" 
        ];
        const comicScenarios = [
            "ì—‡, ì†ê°€ë½ì´ ê¼¬ì˜€êµ°ìš”! ë‹¤ìŒì—” ì˜í•˜ì‹¤ ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.", "ì´ëŸ°, ì•½ì¬ê°€ ë•…ì— ë–¨ì–´ì§€ë‹¤ë‹ˆ! ì›ì¥ë‹˜ê»˜ í˜¼ë‚˜ê² ì–´ìš”.",
            "íƒ€ì ì—°ìŠµë„ í•˜ê³ , í•œì˜í•™ ê³µë¶€ë„ í•˜ê³ ! ì¼ì„ì´ì¡°ì¸ë°ìš”?", "ì§‘ì¤‘! ì§‘ì¤‘! ì˜†ìë¦¬ ê¹€ì„ ë¹„ê°€ ì¡¸ê³  ìˆêµ°ìš”.",
            "ë°©ê¸ˆ ì…ë ¥í•œ ì•½ì¬, ë§›ì€ ì •ë§... í¬ìœ½! ëª¸ì—ëŠ” ì¢‹ê² ì£ ?", "í—ˆë¦¬ê°€ ë»ê·¼í•˜êµ°ìš”. ìŠ¤íŠ¸ë ˆì¹­ í•œë²ˆ í•˜ì‹œì£ !",
            "ì›ì¥ë‹˜ ëª°ë˜ í™ì‚¼ ìŠ¤í‹¸ ì„±ê³µ?! (ì ìˆ˜ +10)", "ì˜†ì§‘ ê°•ì•„ì§€ê°€ ìê¾¸ ì§–ë„¤ìš”. 'ì•ˆì‹ ì§€í™©íƒ•'ì´ í•„ìš”í•˜ë ¤ë‚˜...",
            "ì´ ë§ì€ ì•½ì¬ë¥¼ ì–¸ì œ ë‹¤ ì™¸ìš¸ê¹Œìš”? ê²Œì„ìœ¼ë¡œ ì™¸ì›Œë´…ì‹œë‹¤!", "íƒ€ì ì†ë„ê°€ ë¹¨ë¼ì§€ì…¨ì–´ìš”! í˜¹ì‹œ ì „ìƒì— ì˜ì›ì´ì…¨ëŠ”ì§€?"
        ];
        const heojunMessages = { 
            itemPrefix: "ì–´ì˜ í—ˆì¤€ ë“±ì¥! âœ¨", 
            itemSuffix: " (í•˜íŠ¸ +1 â¤ï¸)",
            encouragement: [ 
                "í—ˆì¤€: 'í›Œë¥­í•˜ë„¤! ê·¸ëŒ€ì˜ ì‹¤ë ¥ì´ ì¼ì·¨ì›”ì¥í•˜ëŠ”êµ¬ë¨¼.'", 
                "í—ˆì¤€: 'ì´ ì •ë„ëŠ” íƒ•ì•½ ë‹¬ì´ëŠ” ê²ƒë³´ë‹¤ ì‰½ì§€ ì•Šì€ê°€?'",
                "í—ˆì¤€: 'ë³‘ì„¸ê°€ ì‹¬ê°í•˜êµ°... ì•„ë‹ˆ, íƒ€ì ì†ë„ê°€ ë§ì¼ì„¸!'", 
                "í—ˆì¤€: 'ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì‹œê²Œ! ë°±ì„±ë“¤ì´ ìë„¤ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆë„¤.'",
                "í—ˆì¤€: 'ì´ë³´ê²Œ ì Šì€ì´, ê·¸ëŒ€ì˜ ì†ë†€ë¦¼ì´ ì˜ˆì‚¬ë¡­ì§€ ì•Šêµ¬ë¨¼!'",
                "í—ˆì¤€: 'ì•½ì¬ë¥¼ ë‹¤ë£¨ëŠ” ì†œì”¨ê°€ ë§ˆì¹˜ ë‚´ ì Šì€ ì‹œì ˆì„ ë³´ëŠ” ë“¯í•˜ë„¤!'"
            ]
        };

        let score = 0;
        let hearts = 5;
        const maxHearts = 5;
        let activeWords = [];
        let gameInterval;
        let wordCreationInterval;
        let gameSpeed = 2000;
        let fallSpeedMultiplier = 1;
        let heojunCooldown = false;
        let quizActive = false;
        let currentQuiz = null; 
        let nextDifficultyScoreThreshold = 50; 
        let isQuizApiHealthy = false; 
        let initialQuizCheckDone = false;

        const API_KEY = ""; 
        const GENERATE_QUIZ_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        const matchEffects = ['fade-out-effect', 'split-effect', 'explode-effect'];


        async function generateHerbQuizFromAPI(herbName, isTestCall = false) {
            const prompt = `í•œì•½ì¬ '${herbName}'ì˜ íš¨ëŠ¥ì— ëŒ€í•œ O/X í€´ì¦ˆë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ì§ˆë¬¸ì€ 30ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ í•´ì£¼ì„¸ìš”. ì •ë‹µì´ O ë˜ëŠ” Xê°€ ë˜ë„ë¡ í•´ì£¼ì„¸ìš”. JSON í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”. í˜•ì‹: { "quiz": "í€´ì¦ˆ ë‚´ìš©", "answer": "O" }`;
            
            if (!isTestCall && quizLoading) {
                 quizLoading.classList.remove('hidden');
                 quizLoading.style.display = 'block'; 
            }
            if (!isTestCall && quizOptions) quizOptions.classList.add('hidden');
            if (!isTestCall && quizSection) quizSection.classList.add('hidden'); 

            console.log(`generateHerbQuizFromAPI: Called for '${herbName}'. isTestCall: ${isTestCall}`);

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: { "quiz": { "type": "STRING" }, "answer": { "type": "STRING", "enum": ["O", "X"] } },
                            required: ["quiz", "answer"]
                        }
                    }
                };
                const response = await fetch(GENERATE_QUIZ_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('Gemini API Quiz Error:', response.status, errorBody);
                    if (!isTestCall) resetFromQuizState("í€´ì¦ˆ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆì–´ìš”.");
                    return null;
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    console.log("generateHerbQuizFromAPI: API Response JSON Text:", jsonText);
                    const parsedData = JSON.parse(jsonText);
                    if (parsedData && parsedData.quiz && parsedData.answer) {
                        console.log("generateHerbQuizFromAPI: Parsed quiz data:", parsedData);
                        return parsedData; 
                    } else {
                         console.error('Gemini API Quiz Error: Parsed data is invalid.', parsedData);
                         if (!isTestCall) resetFromQuizState("í€´ì¦ˆ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.");
                         return null;
                    }
                }
                console.error('Gemini API Quiz Error: Unexpected response structure', result);
                if (!isTestCall) resetFromQuizState("í€´ì¦ˆ API ì‘ë‹µ êµ¬ì¡°ê°€ ì´ìƒí•´ìš”.");
                return null;
            } catch (error) {
                console.error('Error calling/parsing Gemini API for quiz:', error);
                if (!isTestCall) resetFromQuizState("í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
                return null;
            } finally {
                if (!isTestCall && quizLoading) {
                    quizLoading.classList.add('hidden');
                    quizLoading.style.display = 'none'; 
                }
            }
        }

        async function checkQuizApiHealth() {
            console.log("checkQuizApiHealth: Starting API health check...");
            initialQuizCheckDone = false;
            isQuizApiHealthy = false; 
            try {
                const testQuiz = await generateHerbQuizFromAPI("ê°ì´ˆ", true); 
                if (testQuiz && testQuiz.quiz && testQuiz.answer) {
                    isQuizApiHealthy = true;
                    console.log("checkQuizApiHealth: API is healthy.");
                } else {
                    console.warn("checkQuizApiHealth: API health check failed (no valid quiz data).");
                }
            } catch (error) {
                console.error("checkQuizApiHealth: Error during API health check:", error);
            } finally {
                initialQuizCheckDone = true;
                console.log("checkQuizApiHealth: API health check finished. Healthy:", isQuizApiHealthy);
            }
        }
      
        function initGame() {
            console.log("initGame: Called.");
            score = 0;
            hearts = maxHearts;
            activeWords = [];
            gameSpeed = 2000;
            fallSpeedMultiplier = 1;
            heojunCooldown = false;
            quizActive = false;
            currentQuiz = null;
            nextDifficultyScoreThreshold = 50; 
            
            checkQuizApiHealth(); 

            updateScoreDisplay();
            updateHeartsDisplay();
            if(wordInput) {
                wordInput.value = '';
                wordInput.disabled = false;
            }
            
            if(mainMessageTextEl) mainMessageTextEl.textContent = 'ê²Œì„ ì‹œì‘! ë–¨ì–´ì§€ëŠ” í•œì•½ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!';
            if(mainMessageTextEl) mainMessageTextEl.style.display = 'inline'; 

            const heojunImgInMessage = messageArea?.querySelector('.heojun-img');
            if (heojunImgInMessage) heojunImgInMessage.remove(); 
            const heojunTextEl = messageArea?.querySelector('p#heojunMessageText');
             if (heojunTextEl) heojunTextEl.remove(); 
            
            if(quizSection) {
                quizSection.classList.add('hidden');
                quizSection.style.display = 'none'; 
            }
            if(quizLoading) {
                quizLoading.classList.add('hidden');
                quizLoading.style.display = 'none';
            }
            
            if(wordArea) {
                while (wordArea.firstChild) {
                    wordArea.removeChild(wordArea.firstChild);
                }
            }

            if(startScreen) startScreen.classList.add('hidden');
            if(gameOverScreen) gameOverScreen.classList.add('hidden');
            if(gameContainer) gameContainer.classList.remove('hidden'); 
            console.log("initGame: gameContainer unhidden. Visible:", !gameContainer?.classList.contains('hidden'));

            startGameLoops();
            if(wordInput) wordInput.focus(); 
            console.log("initGame: wordInput focused.");
        }

        function startGameLoops() {
            console.log("startGameLoops: Called.");
            if (gameInterval) clearInterval(gameInterval);
            if (wordCreationInterval) clearInterval(wordCreationInterval);

            gameInterval = setInterval(gameLoop, 50);
            wordCreationInterval = setInterval(createWord, gameSpeed);
        }

        function stopGameLoops() {
            console.log("stopGameLoops: Called.");
            clearInterval(gameInterval);
            clearInterval(wordCreationInterval);
            gameInterval = null; 
            wordCreationInterval = null;
        }

        function updateScoreDisplay() {
            if(scoreDisplay) scoreDisplay.textContent = score;
        }

        function updateHeartsDisplay() {
            if (!heartsContainer) return;
            heartsContainer.innerHTML = '';
            for (let i = 0; i < hearts; i++) heartsContainer.innerHTML += '<span>â¤ï¸</span>';
            for (let i = hearts; i < maxHearts; i++) heartsContainer.innerHTML += '<span>ğŸ¤</span>';
        }

        function createWord() {
            if (document.hidden || quizActive || !wordArea) return;

            const randomWordText = herbWords[Math.floor(Math.random() * herbWords.length)];
            const wordElement = document.createElement('div');
            wordElement.classList.add('word');
            wordElement.textContent = randomWordText;
            
            const wordAreaWidth = wordArea.offsetWidth;
            if (wordAreaWidth <= 0) return; 

            const tempWordWidthEstimate = randomWordText.length * 16; 
            let randomX = Math.random() * (wordAreaWidth - tempWordWidthEstimate);
            if (randomX < 0) randomX = 0;
            if (randomX + tempWordWidthEstimate > wordAreaWidth) randomX = Math.max(0, wordAreaWidth - tempWordWidthEstimate);

            wordElement.style.left = `${randomX}px`;
            wordElement.style.top = `0px`;

            const wordObj = {
                element: wordElement,
                text: randomWordText,
                y: 0,
                speed: (Math.random() * 0.5 + 0.5) * fallSpeedMultiplier
            };
            activeWords.push(wordObj);
            wordArea.appendChild(wordElement);
        }

        function gameLoop() {
            if (document.hidden || quizActive) return;

            for (let i = activeWords.length - 1; i >= 0; i--) {
                const wordObj = activeWords[i];
                if (!wordObj || !wordObj.element) continue; 

                wordObj.y += wordObj.speed;
                wordObj.element.style.top = `${wordObj.y}px`;

                if (wordArea && wordObj.y + wordObj.element.offsetHeight > wordArea.offsetHeight) {
                    if (wordArea.contains(wordObj.element)) {
                        wordArea.removeChild(wordObj.element);
                    }
                    activeWords.splice(i, 1); 
                    hearts--;
                    updateHeartsDisplay();
                    showRandomComicScenario(false, `ì´ëŸ°! ì•½ì¬('${wordObj.text}')ë¥¼ ë†“ì³¤ìŠµë‹ˆë‹¤!`);
                    if (hearts <= 0) {
                        gameOver();
                        return; 
                    }
                }
            }

            if (score >= nextDifficultyScoreThreshold && gameSpeed > 500) {
                gameSpeed -= 100; 
                if (gameSpeed < 500) gameSpeed = 500; 
                fallSpeedMultiplier += 0.05; 
                
                clearInterval(wordCreationInterval);
                wordCreationInterval = setInterval(createWord, gameSpeed);
                
                if (!quizActive && mainMessageTextEl) mainMessageTextEl.textContent = "ì ì  ë¹¨ë¼ì§‘ë‹ˆë‹¤! ì§‘ì¤‘í•˜ì„¸ìš”!";
                
                nextDifficultyScoreThreshold += 50; 
                console.log(`Difficulty increased. Next: ${nextDifficultyScoreThreshold}, Speed: ${gameSpeed}`);
            }
            
            if (!heojunCooldown && Math.random() < 0.002) { 
                spawnHeoJun();
            }
        }

        function processWordSubmission(typedText) {
            if (!typedText || quizActive) return; 

            for (let i = activeWords.length - 1; i >= 0; i--) {
                const wordObj = activeWords[i];
                if (wordObj.text === typedText) {
                    const matchedHerb = wordObj.text; 
                    score += 10;
                    updateScoreDisplay();

                    const randomEffect = matchEffects[Math.floor(Math.random() * matchEffects.length)];
                    wordObj.element.className = 'word'; 
                    void wordObj.element.offsetWidth; 
                    wordObj.element.classList.add(randomEffect); 
                    console.log("Applied effect:", randomEffect, "to word:", wordObj.text);

                    const elementToRemove = wordObj.element;
                    const animationDuration = (randomEffect === 'split-effect') ? 600 : 500; 
                    setTimeout(() => {
                        if (wordArea && wordArea.contains(elementToRemove)) {
                           wordArea.removeChild(elementToRemove);
                        }
                    }, animationDuration);

                    activeWords.splice(i, 1);

                    if (Math.random() < 0.15 && !quizActive) { 
                        if (initialQuizCheckDone) {
                            if (isQuizApiHealthy) {
                                triggerHerbQuiz(matchedHerb);
                            } else {
                                showTemporaryMessage("í€´ì¦ˆ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”. ë‹¤ìŒì— ë‹¤ì‹œ ì‹œë„í• ê²Œìš”!");
                            }
                        } else {
                            showTemporaryMessage("í€´ì¦ˆ ì„œë²„ ì ê²€ ì¤‘... ì ì‹œë§Œìš”!");
                        }
                        return; 
                    }

                    if (Math.random() < 0.3) {
                        showRandomComicScenario(false, `'${typedText}' ì…ë ¥ ì„±ê³µ!`);
                    } else {
                        if (!quizActive && mainMessageTextEl) mainMessageTextEl.textContent = `'${typedText}' ì…ë ¥ ì„±ê³µ! (+10ì )`;
                    }

                    if (Math.random() < 0.1 && !heojunCooldown && !quizActive) {
                         const randomEncouragement = heojunMessages.encouragement[Math.floor(Math.random() * heojunMessages.encouragement.length)];
                         if (!quizActive && mainMessageTextEl) mainMessageTextEl.textContent = randomEncouragement;
                    }
                    return; 
                }
            }
        }
        
        function showTemporaryMessage(msg, duration = 2000) {
            if (quizActive || !mainMessageTextEl) return;
            
            mainMessageTextEl.textContent = msg;
            mainMessageTextEl.style.display = 'inline';
            if(quizSection) quizSection.style.display = 'none'; 
            if(quizLoading) quizLoading.style.display = 'none'; 
            
            setTimeout(() => {
                if (mainMessageTextEl.textContent === msg && !quizActive) { 
                     showRandomComicScenario(true); 
                }
            }, duration);
        }


        if (wordInput) {
            wordInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    if (quizActive) return; 

                    const typedText = wordInput.value.trim();
                    processWordSubmission(typedText); 
                    wordInput.value = ''; 
                }
            });
        }

        function resetFromQuizState(failureMessage) {
            console.log("--- resetFromQuizState: START --- Reason:", failureMessage);
            quizActive = false; 
            console.log("resetFromQuizState: quizActive set to false.");
            currentQuiz = null;

            if(wordInput) {
                wordInput.disabled = false;
                console.log("resetFromQuizState: wordInput enabled.");
            } 

            if(quizSection) {
                quizSection.classList.add('hidden');
                quizSection.style.display = 'none'; 
                quizSection.style.border = ''; 
                console.log("resetFromQuizState: quizSection display (computed):", window.getComputedStyle(quizSection).display);
            } 
            if(quizLoading) {
                 quizLoading.classList.add('hidden');
                 quizLoading.style.display = 'none';
            }
            if(quizOptions) quizOptions.style.border = ''; 
            if(quizText) quizText.style.border = ''; 

            requestAnimationFrame(() => { 
                console.log("resetFromQuizState: rAF callback triggered.");
                if (hearts > 0 && mainMessageTextEl) { 
                    showRandomComicScenario(true, failureMessage || "í€´ì¦ˆì— ë¬¸ì œê°€ ìˆì–´ ê²Œì„ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
                } else if (mainMessageTextEl) {
                    mainMessageTextEl.textContent = failureMessage || "ê²Œì„ ìƒíƒœ ë³µêµ¬ ì¤‘...";
                    mainMessageTextEl.style.display = 'inline';
                }

                if (wordInput && !wordInput.disabled && gameContainer && !gameContainer.classList.contains('hidden') && hearts > 0) {
                     try {
                        wordInput.focus();
                        console.log("resetFromQuizState: wordInput focused.");
                     } catch(e) {
                        console.warn("Focus failed in resetFromQuizState", e);
                     }
                }
                console.log("--- resetFromQuizState: END ---");
            }); 
        }

        async function triggerHerbQuiz(herbName) { 
            console.log("--- triggerHerbQuiz: START for", herbName, "---");
            if(!mainMessageTextEl || !quizSection || !quizText || !quizOptions || !wordInput || !quizLoading) {
                console.error("triggerHerbQuiz: Critical UI element missing. Aborting quiz.");
                resetFromQuizState("í€´ì¦ˆ UI êµ¬ì„± ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            quizActive = true; 
            wordInput.disabled = true;
            mainMessageTextEl.style.display = 'none'; 
            
            quizSection.classList.add('hidden'); 
            quizSection.style.display = 'none';
            quizOptions.classList.add('hidden');
            quizOptions.style.display = 'none';

            quizLoading.classList.remove('hidden');
            quizLoading.style.display = 'block'; 
            console.log("triggerHerbQuiz: UI prepared for loading. quizLoading display:", window.getComputedStyle(quizLoading).display);
            
            try {
                const quizData = await generateHerbQuizFromAPI(herbName); 
                
                if (quizActive && quizData && quizData.quiz && quizData.answer) { 
                    console.log("triggerHerbQuiz: Received valid quiz data:", quizData);
                    currentQuiz = { herb: herbName, question: quizData.quiz, answer: quizData.answer };

                    quizText.innerHTML = `âœ¨ ê¹œì§ í€´ì¦ˆ! âœ¨<br>${currentQuiz.question} (O/X)`; 
                    console.log("triggerHerbQuiz: quizText content set.");
                    
                    quizLoading.classList.add('hidden');
                    quizLoading.style.display = 'none';

                    quizSection.classList.remove('hidden');
                    quizOptions.classList.remove('hidden');

                    // ìŠ¤íƒ€ì¼ì„ ì¦‰ì‹œ ì ìš©í•˜ê³ , ë‹¤ìŒ í‹±ì—ì„œ ë¡œê·¸ í™•ì¸
                    quizSection.style.display = 'flex'; 
                    quizSection.style.flexDirection = 'column';
                    quizSection.style.alignItems = 'center';
                    quizSection.style.width = '100%'; 
                    quizSection.style.minHeight = '80px'; // ìµœì†Œ ë†’ì´ ì„¤ì •
                    quizSection.style.padding = '1px'; // ë¸Œë¼ìš°ì €ê°€ ë†’ì´ë¥¼ ê³„ì‚°í•˜ë„ë¡ ì•½ê°„ì˜ íŒ¨ë”© (ë””ë²„ê¹…ìš©)
                    // quizSection.style.border = '2px dashed hotpink'; // ë””ë²„ê¹…ìš© í…Œë‘ë¦¬ (ì„ íƒì )

                    quizOptions.style.display = 'flex';
                    quizOptions.style.justifyContent = 'center'; 
                    // quizOptions.style.border = '1px solid cyan'; // ë””ë²„ê¹…ìš© í…Œë‘ë¦¬ (ì„ íƒì )
                    
                    // quizText.style.border = '1px solid orange'; // ë””ë²„ê¹…ìš© í…Œë‘ë¦¬ (ì„ íƒì )

                    setTimeout(() => { 
                        if (!quizActive) {
                            console.log("triggerHerbQuiz (timeout log): Quiz was reset before logging final UI state.");
                            return; 
                        }
                        const reflow = quizSection.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°
                        console.log("triggerHerbQuiz (after timeout and reflow):");
                        console.log("  messageArea display:", window.getComputedStyle(messageArea).display, "offsetHeight:", messageArea.offsetHeight);
                        console.log("  quizSection display:", window.getComputedStyle(quizSection).display, "offsetHeight:", quizSection.offsetHeight, "classList:", quizSection.classList.toString());
                        console.log("  quizText    display:", window.getComputedStyle(quizText).display, "offsetHeight:", quizText.offsetHeight, "textContent:", quizText.textContent.substring(0,30) + "...");
                        console.log("  quizOptions display:", window.getComputedStyle(quizOptions).display, "offsetHeight:", quizOptions.offsetHeight, "classList:", quizOptions.classList.toString());
                        
                        if(quizSection.offsetHeight === 0 && quizText.offsetHeight > 0) { 
                            console.error("ERROR: quizSection still has 0 height despite content! Parent (messageArea) might be the issue.");
                        } else if (quizSection.offsetHeight > 0) {
                            console.log("SUCCESS: quizSection HAS HEIGHT! UI should be visible.");
                        }
                         // ë””ë²„ê¹… í›„ íŒ¨ë”© ì œê±° (ì‹¤ì œë¡œëŠ” í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ)
                        // quizSection.style.padding = ''; 
                        // quizSection.style.border = ''; 
                        // quizOptions.style.border = '';
                        // quizText.style.border = '';
                    }, 0); 

                } else if (quizActive) { 
                    console.log("triggerHerbQuiz: API call did not return valid quiz data OR quiz was reset. Resetting state.");
                    resetFromQuizState("í€´ì¦ˆë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš”."); 
                }
            } catch (error) {
                console.error("Error during triggerHerbQuiz's API call or processing:", error);
                if (quizActive) { 
                    resetFromQuizState("í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
            console.log("--- triggerHerbQuiz: END ---");
        }

        function handleQuizAnswer(userAnswer) {
            console.log("--- handleQuizAnswer: START --- User answer:", userAnswer);
            if (!currentQuiz || typeof currentQuiz.answer === 'undefined') { 
                 console.error("handleQuizAnswer: currentQuiz is invalid or answer is undefined.");
                 resetFromQuizState("í€´ì¦ˆ ì •ë³´ê°€ ë¶€ì¡±í•˜ì—¬ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 return;
            }
            console.log("handleQuizAnswer: Correct answer was:", currentQuiz.answer);

            let resultMessage = "";
            if (userAnswer === currentQuiz.answer) {
                score += 20; 
                updateScoreDisplay();
                resultMessage = `ì •ë‹µì…ë‹ˆë‹¤! (+20ì ) âœ¨`;
                console.log("handleQuizAnswer: Correct!");
            } else {
                hearts--; 
                updateHeartsDisplay();
                resultMessage = `ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ '${currentQuiz.answer}'ì˜€ìŠµë‹ˆë‹¤. (í•˜íŠ¸ -1 â¤ï¸)`;
                console.log("handleQuizAnswer: Incorrect.");
                if (hearts <= 0) {
                    gameOver(); 
                    return; 
                }
            }
            
            if(quizSection) {
                quizSection.classList.add('hidden'); 
                quizSection.style.display = 'none'; 
                quizSection.style.border = ''; 
                quizSection.style.padding = ''; // ì¶”ê°€ëœ íŒ¨ë”© ì œê±°
                console.log("handleQuizAnswer: quizSection hidden.");
            } 
            if(quizOptions) quizOptions.style.border = '';
            if(quizText) quizText.style.border = '';
            if(quizLoading) quizLoading.classList.add('hidden'); 

            if(mainMessageTextEl) { 
                mainMessageTextEl.textContent = resultMessage; 
                mainMessageTextEl.style.display = 'inline'; 
                console.log("handleQuizAnswer: Result message set to mainMessageTextEl:", resultMessage);
            }
            
            quizActive = false; 
            console.log("handleQuizAnswer: quizActive set to false.");
            currentQuiz = null;
            if(wordInput) {
                wordInput.disabled = false;
                console.log("handleQuizAnswer: wordInput enabled.");
            }

            setTimeout(() => {
                console.log("handleQuizAnswer: setTimeout callback triggered.");
                if (!quizActive && hearts > 0 && mainMessageTextEl) {
                    showRandomComicScenario(true); 
                }
                 if (wordInput && !wordInput.disabled && gameContainer && !gameContainer.classList.contains('hidden') && hearts > 0) {
                     try {
                        wordInput.focus();
                        console.log("handleQuizAnswer: wordInput focused in timeout.");
                     } catch(e) {
                        console.warn("Focus failed in handleQuizAnswer timeout", e);
                     }
                }
                console.log("--- handleQuizAnswer: END ---");
            }, 3000); 
        }

        if(quizBtnO) quizBtnO.addEventListener('click', () => handleQuizAnswer("O"));
        if(quizBtnX) quizBtnX.addEventListener('click', () => handleQuizAnswer("X"));

        function spawnHeoJun() { 
            if (quizActive || !messageArea) return; 
            heojunCooldown = true;
            
            if(mainMessageTextEl) mainMessageTextEl.style.display = 'none';
            if(quizSection) {
                quizSection.classList.add('hidden');
                quizSection.style.display = 'none';
            }
            if(quizLoading) quizLoading.classList.add('hidden');


            messageArea.innerHTML = ''; 
            const heojunIcon = document.createElement('img');
            heojunIcon.src = 'https://placehold.co/60x60/A52A2A/FFFFFF?text=í—ˆì¤€&font=NanumGothic';
            heojunIcon.alt = 'í—ˆì¤€ ì„ ìƒë‹˜';
            heojunIcon.classList.add('heojun-img', 'mx-auto');
            heojunIcon.onerror = function() { this.src='https://placehold.co/60x60/A52A2A/FFFFFF?text=í—ˆì¤€&font=NanumGothic'; };
            messageArea.appendChild(heojunIcon);

            const heojunTextElement = document.createElement('p');
            heojunTextElement.id = 'heojunMessageText'; 
            const randomEncouragement = heojunMessages.encouragement[Math.floor(Math.random() * heojunMessages.encouragement.length)];
            
            if (hearts < maxHearts) {
                hearts++;
                updateHeartsDisplay();
                heojunTextElement.textContent = `${heojunMessages.itemPrefix} ${randomEncouragement} ${heojunMessages.itemSuffix}`;
            } else {
                heojunTextElement.textContent = `${heojunMessages.itemPrefix} ${randomEncouragement} (ì´ë¯¸ ì²´ë ¥ì´ ë„˜ì¹˜ëŠ”êµ¬ë¨¼!)`;
            }
            messageArea.appendChild(heojunTextElement);
            
            setTimeout(() => {
                heojunCooldown = false;
                if(messageArea.contains(heojunIcon) && !quizActive && hearts > 0) {
                     messageArea.innerHTML = ''; 
                     if(mainMessageTextEl) mainMessageTextEl.style.display = 'inline'; 
                    showRandomComicScenario(true);
                }
            }, 30000); 

            setTimeout(() => { 
                if(messageArea.contains(heojunIcon) && !quizActive && hearts > 0 && heojunCooldown) { 
                     messageArea.innerHTML = ''; 
                     if(mainMessageTextEl) mainMessageTextEl.style.display = 'inline';
                     showRandomComicScenario(true);
                }
            }, 5000);
        }

        function showRandomComicScenario(isGeneral = false, prefixMessage = "") {
            if (quizActive || !mainMessageTextEl) return; 
            
            const heojunImgInMessage = messageArea?.querySelector('.heojun-img');
            if (heojunImgInMessage) heojunImgInMessage.remove();
            const heojunTextInMessage = messageArea?.querySelector('p#heojunMessageText');
             if (heojunTextInMessage) heojunTextInMessage.remove();

            let scenario = "";
            if (isGeneral || Math.random() < 0.25) {
                scenario = comicScenarios[Math.floor(Math.random() * comicScenarios.length)];
            }
            
            let fullMessage = prefixMessage ? `${prefixMessage} ${scenario}` : scenario;
            if (!fullMessage && isGeneral) { 
                 fullMessage = "ê³„ì†í•´ì„œ ì§‘ì¤‘í•˜ì„¸ìš”!";
            }

            mainMessageTextEl.textContent = fullMessage; 
            mainMessageTextEl.style.display = 'inline'; 
            if(quizSection) quizSection.style.display = 'none'; 
            if(quizLoading) quizLoading.style.display = 'none'; 


            if (scenario.includes("í™ì‚¼ ìŠ¤í‹¸ ì„±ê³µ")) {
                score += 10;
                updateScoreDisplay();
                mainMessageTextEl.textContent += " (íŠ¹ë³„ ë³´ë„ˆìŠ¤ +10ì !)";
            }
        }

        function gameOver() {
            console.log("gameOver: Called.");
            stopGameLoops();
            if(wordInput) wordInput.disabled = true;
            quizActive = false; 
            if(quizSection) {
                quizSection.classList.add('hidden');
                quizSection.style.display = 'none';
            }
            if(quizLoading) {
                quizLoading.classList.add('hidden');
                quizLoading.style.display = 'none';
            }


            if(finalScoreDisplay) finalScoreDisplay.textContent = score;
            let msg = "ì•„ì‰½ì§€ë§Œ, ëª¨ë“  ì•½ì¬ë¥¼ ì§€í‚¤ì§€ ëª»í–ˆë„¤ìš”.";
            if (score > 200) msg = "ëŒ€ë‹¨í•©ë‹ˆë‹¤! ëª…ì˜ì˜ ìì§ˆì´ ë³´ì´ëŠ”êµ°ìš”!";
            else if (score > 100) msg = "í›Œë¥­í•©ë‹ˆë‹¤! ë‹¤ìŒì—” ë” ë†’ì€ ì ìˆ˜ë¥¼ í–¥í•´!";
            else if (score > 50) msg = "ì˜í•˜ì…¨ì–´ìš”! ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ëª…ì˜ê°€ ë  ìˆ˜ ìˆì–´ìš”!";
            if(gameOverMessage) gameOverMessage.textContent = msg;
            if(gameOverScreen) gameOverScreen.classList.remove('hidden');
        }

        if(startButton) {
            startButton.addEventListener('click', () => {
                console.log("startButton: Clicked.");
                initGame();
            });
        }
        if(restartButton) { 
            restartButton.addEventListener('click', () => {
                 console.log("gameOverScreen restartButton: Clicked.");
                 if(gameOverScreen) gameOverScreen.classList.add('hidden');
                 if(startScreen) startScreen.classList.remove('hidden'); 
            });
        }
        if(ingameRestartButton) { 
            ingameRestartButton.addEventListener('click', () => {
                console.log("ingameRestartButton: Clicked.");
                stopGameLoops(); 
                initGame(); 
            });
        }
        
        window.addEventListener('resize', () => { /* í˜„ì¬ íŠ¹ë³„í•œ ì²˜ë¦¬ ì—†ìŒ */ });

        function showInitialScreen() {
            console.log("showInitialScreen: Called.");
            updateHeartsDisplay(); 
            
            if(startScreen) startScreen.classList.remove('hidden');
            if(gameOverScreen) gameOverScreen.classList.add('hidden');
            if(gameContainer) gameContainer.classList.add('hidden');
            
            console.log("showInitialScreen: startScreen visible:", startScreen ? !startScreen.classList.contains('hidden') : "not found");
        }
        
        window.onload = () => {
            console.log("window.onload: Event triggered.");
            showInitialScreen();
        };
    </script></body></html>
